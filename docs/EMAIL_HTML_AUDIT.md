# Email Pipeline + HTML Rendering Audit Report

Scope: Customer order confirmation email rendering and send path (Resend + Stripe webhook). This is a read-only audit plus debug instrumentation behind `EMAIL_DEBUG=1`.

## 1) Email sending map (all send locations)

- `functions/_lib/email.ts` - `sendEmail(args, env)`; provider is Resend via `fetch('https://api.resend.com/emails')`; payload includes `from`, `to[]`, `subject`, `html`, `text`, `reply_to`, `attachments`.
- `functions/api/webhooks/stripe.ts` - `onRequestPost` (Stripe webhook):
  - Customer confirmation (shop order): `sendEmail` to `customerEmail`, subject `The Chesapeake Shell - Order Confirmed (${orderLabel})`, `html` + `text` from `renderOrderConfirmationEmailHtml/Text`.
  - Owner new sale (shop order): `sendEmail` to `ownerTo`, subject `NEW SALE - The Chesapeake Shell (${orderLabel})`, `html` + `text` from `renderOwnerNewSaleEmailHtml/Text`.
  - Custom invoice payment (customer): `sendEmail` to `customerEmail`, subject `Payment received - The Chesapeake Shell`, `html` + `text` inline.
  - Custom invoice payment (owner): `sendEmail` to `ownerTo`, subject from `renderOwnerInvoicePaidEmail` in `functions/_lib/emailTemplates.ts`.
  - Custom order payment (customer): `sendEmail` to `confirmationCustomerEmail`, subject `The Chesapeake Shell - Order Confirmed (${orderLabel})`, `html` + `text` from `renderOrderConfirmationEmailHtml/Text`.
  - Custom order payment (owner): `sendEmail` to `ownerTo`, subject `NEW SALE - The Chesapeake Shell (${orderLabel})`, `html` + `text` from `renderOwnerNewSaleEmailHtml/Text`.
- `functions/api/admin/custom-orders/[id]/send-payment-link.ts` - customer payment link email: subject `The Chesapeake Shell - Custom Order`, `html` + `text` inline.
- `functions/api/custom-invoices/create.ts` - customer invoice email: subject `Invoice from The Chesapeake Shell - ${amountFormatted}`, `html` + `text` inline.
- `functions/api/messages.ts` - owner inquiry email: subject `New Inquiry - The Chesapeake Shell`, `html` + `text` + optional attachment.
- `functions/api/email/test.ts` - test endpoint for owner new sale template.

## 2) Trigger event and path (customer confirmation)

- **Primary trigger:** `functions/api/webhooks/stripe.ts` in `onRequestPost` for `checkout.session.completed`.
- **Standard shop orders:** after `insertStandardOrderAndItems`, when `insertResult && customerEmail`.
- **Custom orders:** same event, routed through `handleCustomOrderPayment` when metadata includes `customOrderId` or `source=custom_order`.
- **No return-page trigger:** the confirmation email is not sent from a return route or page; it is webhook-driven.

## 3) Template selection logic

- **Customer confirmation HTML/Text template:** `functions/_lib/orderConfirmationEmail.ts` via `renderOrderConfirmationEmailHtml` and `renderOrderConfirmationEmailText`.
- **Owner new sale template:** `functions/_lib/ownerNewSaleEmail.ts` via `renderOwnerNewSaleEmailHtml/Text`.
- **Owner invoice template:** `functions/_lib/emailTemplates.ts` via `renderOwnerInvoicePaidEmail`.
- **Inline templates:** custom order payment link and invoice creation use inline HTML strings in their respective route handlers.

**Implication:** If the “new template” you edited is not `functions/_lib/orderConfirmationEmail.ts`, it is not wired to the customer confirmation email.

## 4) What HTML is passed to Resend

- `sendEmail` always posts `html` + `text` fields to Resend (no `react` field is used anywhere in this repo).
- Customer confirmation passes **both** `html` and `text` generated by the order confirmation template functions.
- `sendEmail` rejects missing body if both `html` and `text` are falsy. If the customer email is delivered, the runtime body should not be empty.

## 5) HTML generation and runtime inputs

**Order confirmation HTML generation** (`functions/_lib/orderConfirmationEmail.ts`):
- Uses a table-based HTML string with inline styles.
- Always returns a non-empty string; if no items are present, it renders a “No items found” row.
- No `<html>`/`<body>` wrapper is added (generally OK for email clients, but worth noting).

**Inputs feeding the template** (`functions/api/webhooks/stripe.ts`):
- Items come from Stripe line items and are mapped through `mapLineItemsToEmailItemsWithImages` (fallback `name = 'Item'`), so `item.name` should never be undefined.
- `primaryCtaUrl` is always provided (checkout return URL).
- `customerEmail` gate prevents send if missing.

**Potential runtime nulls that could affect rendering:**
- `customerName`, `shippingAddress`, `billingAddress`, `paymentMethod` are optional; template handles these with defaults.
- An exception in `renderOrderConfirmationEmailHtml/Text` would prevent the send entirely (email would not arrive).

## 6) Differences: owner vs customer wiring

- **Customer confirmation:** `renderOrderConfirmationEmailHtml/Text` (order confirmation template). Triggered only from Stripe webhook.
- **Owner sale:** `renderOwnerNewSaleEmailHtml/Text` with a different item mapping and totals formatting.
- **Owner invoice:** `renderOwnerInvoicePaidEmail` from `functions/_lib/emailTemplates.ts`.

## 7) Gmail clipped/blank message - likely causes in this codebase

Ranked suspects based on current wiring:
1) **Message size / clipping from large images** - item image URLs can come from DB or Stripe; if any image is a data URI or huge inline URL, the HTML can balloon and Gmail will clip. A clipped message can look empty if most visible content is below the clip.
2) **HTML render failing silently upstream** - if template render throws, the send would be skipped. Since Gmail receives the email, this is less likely unless the email is from a different path or environment.
3) **HTML missing or empty at runtime** - `sendEmail` rejects missing `html`/`text`, so the email would not send. Also unlikely given email delivery.
4) **Malformed HTML / client rendering quirk** - the template is table-based and inline-styled, which generally renders in Gmail. No `<body>` tag could be a factor, but it rarely produces an empty body.
5) **Text color / visibility** - colors are dark on white, so not likely a white-on-white issue.

## 8) Debug logs added (behind EMAIL_DEBUG=1)

- `functions/api/webhooks/stripe.ts`:
  - Logs when customer confirmation email is prepared (shop + custom).
  - Fields: `kind`, `to`, `subject`, `htmlLen`, `textLen`, `preview` (first 300 chars).
  - Logs template render failures with `[email] template render failed` when `EMAIL_DEBUG=1`.

**Enable:** set `EMAIL_DEBUG=1` in the runtime environment (Cloudflare Pages/Workers env vars).

